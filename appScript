// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firestore
const config = {
  "client_email": "firebase-adminsdk-fbsvc@dima-db764.iam.gserviceaccount.com",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC56NBEiIV3c5aB\nQEwWs+aiH9XBUjYBuGhvgnP/ghZdCEnheoBwov11UEdLdo6/vfxc7IqAXA/lVdJn\njEGmmM46DYOoGWephQarfqdte151+oM1/HKka6LZmfVPsbmYBaufoSRU3eN4TbAy\nlRqdS3gT8egrbTLbv3kDUNPE3GDxfXeRYRvvUfpFMwH4AHbn9yaZfKMH9KOUnTMA\nMCt01FJ4qGN+p/TytXKLitHy0YDixpO17ecAZdactrI7pDw+ELSrYBg4u75wLUxY\nmp+kENfrYqnTSxfns9rZBgOKQYMa9Jc1G3L9RvyNJdtetGD5jImZE5kyWPcagvO3\nsFYT4HCzAgMBAAECggEAAulHzaS3qB1EiyWAAN10Omi2NtJmzxsWcc5dHIyxymcO\nNucYP+tMmjvAUSxfnKuePbC56WaOxyrFKXEsVOcmPAl+QFxAmLUoMPiJKThaE2M4\nuZEzMUcsqyysTl2uD0qMVGri3JixmUP2n4+2StDXkLRkWmhn+DPBVjTmbroKTe3H\nKOTA8bDzPzWw/NlAYAoTkJlpO8cuxVaFFmxjnX52Gt9+ZKVuUIGec6fR8ijTyrdu\nTI4i1i0eTlYq3shX/0ok31+2I/VUzbAeNmOblgvy2ekC9MuFWq6GBarxcFQR8RGA\nZDLsgCpVWc/ke/05JT0YQMUPRtkTGezvNjXsRlAVcQKBgQDk5WMeF9HcMk8XGUx8\nSMEAFoXpzyetUHBHXWmgXLZuMGev182EGBm7hjw+QTDaOrMtuL8fn0kqEUsKX3oO\nnmP7xgCDe/GlDTuNpAU6vAigCr7LzD2jhAV9jBl1zAnfO9N05M0VrLjOo/GOIBYH\n/KwRGiicL4B/D6tqCqR2imEnYwKBgQDP7FtTFSdUl9UNz1uiKaNP50K1GbXOi0AQ\nKn5ONAykN1XL8BFXqWo15GG0FdKNWsoLNVL2JEXA9HUYzUT3INaTINhWKuKMfJ18\nK8s9KhzPIcQCfqrNrogCibNHiiZ/5zH0MxHy8hW1CEhdEoMRrwgXzN/rATvJ2LHP\nQz9/hmoacQKBgB6BK4pxJjiwQ7YSWw0dLQtz9PjJ8MG6PJxmKJOEh5N7w/W9TthR\n1ewV4aVyTq5msEZhnqb6NWfz0gpZ2wxjs3N0WdEsDXIvp0YjG8dOE+AwTmkemQBX\nsdufdi0qug4UDQRBEcvXrvFrC+AjCoyZ8dx9nffipL9KOU/yhyR9IKF9AoGBAKb+\nUircZoZOm9NHo3UOtBfMyYriZ17IAF/7gQ4WR8DsoH/3BDa/3ooCL2aP0Fevf26Z\nGVSPtWZP8GxHEQja2vu3+YjbULE8tM+x7L3nQNQrbl4ClfQ0JRDEv7TJhDpd2YUk\nL1pMjJqlWFlIMPTW+00CQyVgDEEFRWoNvMYTksxBAoGBAOGHPv0x9vMqYIfSnPaS\n7hlH2YuU/SCa5nYt8iNz5dKD1a9Jlxk8NVmA7GEjh18uRYa2aP6ZbKWzjtH1yN2u\n7UTdznZ2786tgUQ1z0ASAuTPoFS/P5YBbeEE2L6mB8+d3CXB7GSK20v72Y6ieDOV\n4Lp7deUuWQt3QaUZf5xGy9lE\n-----END PRIVATE KEY-----\n",
  "project_id": "dima-db764",
};

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ FirestoreApp
// –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: 1VUSl4b1r1eoNcRWotZM3e87ygkxvXlv4Ne7Fin6b0tpo5fLaetGaxKt
const firestore = FirestoreApp.getFirestore(config.client_email, config.private_key, config.project_id);

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
function myFunction() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    Logger.log("–ó–∞–ø—É—Å–∫ myFunction");
    updateCooksSheet(ss);
    updateWaitersSheet(ss);
    updateVotesSheet(ss);
    updateUnregisteredUsersSheet(ss); // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ª–∏—Å—Ç–∞ UnregisteredUsers
    Logger.log("myFunction —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –≤ myFunction: " + error.stack);
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
function clearAllData() {
  try {
    const usersDocs = firestore.getDocuments("users");
    usersDocs.forEach(doc => firestore.deleteDocument(`users/${doc.id}`));

    const votesDocs = firestore.getDocuments("votes");
    votesDocs.forEach(doc => firestore.deleteDocument(`votes/${doc.id}`));

    const adminsDocs = firestore.getDocuments("admins");
    adminsDocs.forEach(doc => firestore.deleteDocument(`admins/${doc.id}`));

    const settingsDocs = firestore.getDocuments("settings");
    settingsDocs.forEach(doc => firestore.deleteDocument(`settings/${doc.id}`));

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const cooksSheet = ss.getSheetByName("Cooks");
    const waitersSheet = ss.getSheetByName("Waiters");
    const votesSheet = ss.getSheetByName("Votes");
    const unregisteredSheet = ss.getSheetByName("UnregisteredUsers");

    if (cooksSheet) cooksSheet.clear();
    if (waitersSheet) waitersSheet.clear();
    if (votesSheet) votesSheet.clear();
    if (unregisteredSheet) unregisteredSheet.clear();

    if (cooksSheet) cooksSheet.getRange("A1:E1").setValues([["‚Ññ", "–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–ó–≤–µ–∑–¥—ã", "–°–≤–∏–Ω—å–∏"]]);
    if (waitersSheet) waitersSheet.getRange("A1:E1").setValues([["‚Ññ", "–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–ó–≤–µ–∑–¥—ã", "–°–≤–∏–Ω—å–∏"]]);
    if (votesSheet) votesSheet.getRange("A1:C1").setValues([["–ü–æ–≤–∞—Ä–∞", "–û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã", "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"]]);
    if (unregisteredSheet) unregisteredSheet.getRange("A1:C1").setValues([["–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–†–æ–ª—å"]]);

    Logger.log("–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + error.stack);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ —Å –ø–æ–≤–∞—Ä–∞–º–∏
function updateCooksSheet(ss) {
  try {
    const sheet = ss.getSheetByName("Cooks");
    if (!sheet) throw new Error("–õ–∏—Å—Ç 'Cooks' –Ω–µ –Ω–∞–π–¥–µ–Ω");
    sheet.clear();
    sheet.getRange("A1:E1").setValues([["‚Ññ", "–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–ó–≤–µ–∑–¥—ã", "–°–≤–∏–Ω—å–∏"]]);

    const usersDocs = firestore.getDocuments("users");
    Logger.log("–ü–æ–ª—É—á–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ users: " + usersDocs.length);
    if (usersDocs.length > 0) Logger.log("–ü—Ä–∏–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: " + JSON.stringify(usersDocs[0]));

    const cooksDocs = usersDocs.filter(doc => 
      doc.fields?.role?.stringValue === "cook" && 
      doc.fields?.registered?.booleanValue === true
    );
    Logger.log("–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ–≤–∞—Ä–æ–≤: " + cooksDocs.length);

    const votesDocs = firestore.getDocuments("votes");
    Logger.log("–ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤: " + votesDocs.length);

    let row = 2;
    cooksDocs.forEach((cook, index) => {
      const id = cook.fields.id.stringValue;
      const surname = cook.fields.surname?.stringValue || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
      const name = cook.fields.name?.stringValue || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
      const stars = votesDocs.filter(vote => vote.fields?.to?.stringValue === id && vote.fields?.type?.stringValue === "star").length;
      const pigs = votesDocs.filter(vote => vote.fields?.to?.stringValue === id && vote.fields?.type?.stringValue === "pig").length;
      
      Logger.log(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤–∞—Ä–∞: ${surname} ${name}, –∑–≤–µ–∑–¥—ã: ${stars}, —Å–≤–∏–Ω—å–∏: ${pigs}`);
      sheet.getRange(`A${row}:E${row}`).setValues([[index + 1, surname, name, stars, pigs]]);
      row++;
    });

    if (row === 2) Logger.log("–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–≤–∞—Ä–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –≤ updateCooksSheet: " + error.stack);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ —Å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞–º–∏
function updateWaitersSheet(ss) {
  try {
    const sheet = ss.getSheetByName("Waiters");
    if (!sheet) throw new Error("–õ–∏—Å—Ç 'Waiters' –Ω–µ –Ω–∞–π–¥–µ–Ω");
    sheet.clear();
    sheet.getRange("A1:E1").setValues([["‚Ññ", "–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–ó–≤–µ–∑–¥—ã", "–°–≤–∏–Ω—å–∏"]]);

    const usersDocs = firestore.getDocuments("users");
    Logger.log("–ü–æ–ª—É—á–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ users: " + usersDocs.length);
    if (usersDocs.length > 0) Logger.log("–ü—Ä–∏–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: " + JSON.stringify(usersDocs[0]));

    const waitersDocs = usersDocs.filter(doc => 
      doc.fields?.role?.stringValue === "waiter" && 
      doc.fields?.registered?.booleanValue === true
    );
    Logger.log("–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤: " + waitersDocs.length);

    const votesDocs = firestore.getDocuments("votes");
    Logger.log("–ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤: " + votesDocs.length);

    let row = 2;
    waitersDocs.forEach((waiter, index) => {
      const id = waiter.fields.id.stringValue;
      const surname = waiter.fields.surname?.stringValue || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
      const name = waiter.fields.name?.stringValue || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
      const stars = votesDocs.filter(vote => vote.fields?.to?.stringValue === id && vote.fields?.type?.stringValue === "star").length;
      const pigs = votesDocs.filter(vote => vote.fields?.to?.stringValue === id && vote.fields?.type?.stringValue === "pig").length;
      
      Logger.log(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞: ${surname} ${name}, –∑–≤–µ–∑–¥—ã: ${stars}, —Å–≤–∏–Ω—å–∏: ${pigs}`);
      sheet.getRange(`A${row}:E${row}`).setValues([[index + 1, surname, name, stars, pigs]]);
      row++;
    });

    if (row === 2) Logger.log("–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –≤ updateWaitersSheet: " + error.stack);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ —Å –≥–æ–ª–æ—Å–∞–º–∏
function updateVotesSheet(ss) {
  try {
    const sheet = ss.getSheetByName("Votes");
    if (!sheet) throw new Error("–õ–∏—Å—Ç 'Votes' –Ω–µ –Ω–∞–π–¥–µ–Ω");
    sheet.clear();
    sheet.getRange("A1:C1").setValues([["–ü–æ–≤–∞—Ä–∞", "–û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã", "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"]]);

    const votesDocs = firestore.getDocuments("votes");
    const usersDocs = firestore.getDocuments("users");
    Logger.log("–ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤: " + votesDocs.length);
    Logger.log("–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: " + usersDocs.length);

    const cooksVotes = {};
    const waitersVotes = {};

    votesDocs.forEach(vote => {
      const toUser = usersDocs.find(user => user.fields?.id?.stringValue === vote.fields?.to?.stringValue);
      if (!toUser) return;

      const fullName = `${toUser.fields?.surname?.stringValue || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"} ${toUser.fields?.name?.stringValue || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}`;
      const voteType = vote.fields?.type?.stringValue === "star" ? "stars" : "pigs";
      const targetRole = vote.fields?.targetRole?.stringValue;

      if (targetRole === "cook") {
        cooksVotes[fullName] = cooksVotes[fullName] || { stars: 0, pigs: 0 };
        cooksVotes[fullName][voteType]++;
      } else if (targetRole === "waiter") {
        waitersVotes[fullName] = waitersVotes[fullName] || { stars: 0, pigs: 0 };
        waitersVotes[fullName][voteType]++;
      }
    });

    let row = 2;
    for (const [fullName, counts] of Object.entries(cooksVotes)) {
      sheet.getRange(`A${row}`).setValue(`${fullName}: ‚òÖ${counts.stars || 0} üê∑${counts.pigs || 0}`);
      row++;
    }

    row = 2;
    for (const [fullName, counts] of Object.entries(waitersVotes)) {
      sheet.getRange(`B${row}`).setValue(`${fullName}: ‚òÖ${counts.stars || 0} üê∑${counts.pigs || 0}`);
      row++;
    }

    sheet.getRange("C2").setValue(new Date().toLocaleString());

    if (Object.keys(cooksVotes).length === 0) Logger.log("–ù–µ—Ç –≥–æ–ª–æ—Å–æ–≤ –∑–∞ –ø–æ–≤–∞—Ä–æ–≤");
    if (Object.keys(waitersVotes).length === 0) Logger.log("–ù–µ—Ç –≥–æ–ª–æ—Å–æ–≤ –∑–∞ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –≤ updateVotesSheet: " + error.stack);
  }
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏—Å—Ç–∞ UnregisteredUsers
function updateUnregisteredUsersSheet(ss) {
  try {
    const sheet = ss.getSheetByName("UnregisteredUsers");
    if (!sheet) throw new Error("–õ–∏—Å—Ç 'UnregisteredUsers' –Ω–µ –Ω–∞–π–¥–µ–Ω");
    sheet.clear();
    sheet.getRange("A1:C1").setValues([["–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–†–æ–ª—å"]]);

    const usersDocs = firestore.getDocuments("users");
    Logger.log("–ü–æ–ª—É—á–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ users: " + usersDocs.length);
    if (usersDocs.length > 0) Logger.log("–ü—Ä–∏–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞: " + JSON.stringify(usersDocs[0]));

    const unregisteredUsers = usersDocs.filter(doc => 
      doc.fields?.registered?.booleanValue === false
    );
    Logger.log("–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: " + unregisteredUsers.length);

    let row = 2;
    unregisteredUsers.forEach(user => {
      const surname = user.fields.surname?.stringValue || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
      const name = user.fields.name?.stringValue || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
      const role = user.fields.role?.stringValue || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
      
      Logger.log(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${surname} ${name}, —Ä–æ–ª—å: ${role}`);
      sheet.getRange(`A${row}:C${row}`).setValues([[surname, name, role]]);
      row++;
    });

    if (row === 2) Logger.log("–ù–µ—Ç –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –≤ updateUnregisteredUsersSheet: " + error.stack);
  }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞
function createTrigger() {
  try {
    ScriptApp.getProjectTriggers().forEach(trigger => ScriptApp.deleteTrigger(trigger));
    ScriptApp.newTrigger("myFunction")
      .timeBased()
      .everyMinutes(1)
      .create();
    Logger.log("–¢—Ä–∏–≥–≥–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞: " + error.stack);
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action; // –î–µ–π—Å—Ç–≤–∏–µ: "add" –∏–ª–∏ "remove"
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('UnregisteredUsers');
    
    if (action === 'add') {
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
      const surname = data.surname;
      const name = data.name;
      const role = data.role;
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏—Å—Ç–∞
      const dataRange = sheet.getDataRange();
      const values = dataRange.getValues();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ
      let userExists = false;
      for (let i = 1; i < values.length; i++) { // –ù–∞—á–∏–Ω–∞–µ–º —Å 1, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if (values[i][0] === surname && values[i][1] === name && values[i][2] === role) {
          userExists = true;
          break;
        }
      }
      
      if (!userExists) {
        sheet.appendRow([surname, name, role]);
      }
      
      return ContentService.createTextOutput(JSON.stringify({ status: 'success' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'remove') {
      // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
      const surname = data.surname;
      const name = data.name;
      const role = data.role;
      
      const dataRange = sheet.getDataRange();
      const values = dataRange.getValues();
      
      // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
      for (let i = 1; i < values.length; i++) {
        if (values[i][0] === surname && values[i][1] === name && values[i][2] === role) {
          sheet.deleteRow(i + 1); // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É (i + 1, —Ç–∞–∫ –∫–∞–∫ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Google Sheets –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1)
          break;
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({ status: 'success' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Invalid action' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
